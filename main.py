import csv
import os

from dotenv import load_dotenv
from netmiko import ConnectHandler

load_dotenv()
HOST = os.environ.get("HOST")
USERNAME = os.environ.get("USERNAME")
PASSWORD = os.environ.get("PASSWORD")


FIREWALL = {
    "device_type": "paloalto_panos",
    "host": HOST,
    "username": USERNAME,
    "password": PASSWORD,
}

CSV_DIR = "input/"
# FILENAME = "vulnerability-protection.csv"
FILENAME = "test.csv"
SEVERITY = ["critical", "high"]
ACTION = "reset-both"


def csv_to_dict(file):
    """Consumes the CSV file generated from Palo Alto Vulnerability Exception
        List and returns a list of dictionaries

    Args:
        file (str): Location and and name of the file

    Returns:
        data (list): CSV converted to list of dictionary
    """
    with open(file, mode="r", encoding="utf-8-sig") as f:
        csv_reader = csv.DictReader(f)
        data = list(csv_reader)
    return data


if __name__ == "__main__":

    vuln_exemptions = csv_to_dict(CSV_DIR + FILENAME)

    connection = ConnectHandler(**FIREWALL)
    connection.config_mode()
    for vuln_exemption in vuln_exemptions:
        if vuln_exemption["Severity"].lower() in SEVERITY:
            output = connection.send_command(
                f"set shared profiles vulnerability Global_Vuln_Prot threat-exception {vuln_exemption['ID']} action {ACTION}"
            )
            print(output)
    connection.disconnect()
